const fs = require('fs')
const path = require('path')

const srcDir = path.join(__dirname, '../src')
const mappingFile = path.join(__dirname, 'lucide-mapping.ts')
const indexFile = path.join(srcDir, 'all-icons.ts')
const outputFile = path.join(srcDir, 'lucide.ts')

// Parse compare/src/mapping.ts to extract entries
const mappingContent = fs.readFileSync(mappingFile, 'utf-8')
const entries = []
const entryRegex =
  /\{\s*lucideName:\s*'([^']+)',\s*fingertipName:\s*'([^']+)',\s*category:\s*'([^']+)',\s*hasMatch:\s*(true|false)/g
let match

while ((match = entryRegex.exec(mappingContent)) !== null) {
  entries.push({
    lucideName: match[1],
    fingertipName: match[2],
    hasMatch: match[4] === 'true',
  })
}

console.log(`Found ${entries.length} mappings in compare/src/mapping.ts`)

// Only use entries with hasMatch: true
const validEntries = entries.filter((e) => e.hasMatch)
console.log(`${validEntries.length} entries with hasMatch: true`)

// Parse index.ts to build a map of export name -> module path
const indexContent = fs.readFileSync(indexFile, 'utf-8')
const exportMap = {}
const exportRegex = /export \{ default as (\w+) \} from '\.\/([^']+)'/g

while ((match = exportRegex.exec(indexContent)) !== null) {
  exportMap[match[1]] = match[2]
}

// Build output
const lines = [
  '// Auto-generated by scripts/generate-lucide-compat.js — do not edit manually.',
  '',
  "import { createLucideIcon } from './create-lucide-icon'",
  "export type { LucideProps, LucideIcon } from './lucide-types'",
  '',
]
const errors = []
const seen = new Set()

for (const { lucideName, fingertipName } of validEntries) {
  const modulePath = exportMap[fingertipName]

  if (!modulePath) {
    errors.push(
      `  ✗ ${lucideName} → ${fingertipName} (not found in src/all-icons.ts)`,
    )
    continue
  }

  if (seen.has(lucideName)) {
    errors.push(`  ✗ ${lucideName} is duplicated in the map`)
    continue
  }
  seen.add(lucideName)

  lines.push(`import _${lucideName} from './${modulePath}'`)
  lines.push(
    `export const ${lucideName} = createLucideIcon('${lucideName}', _${lucideName})`,
  )
}

if (errors.length > 0) {
  console.error('Mapping errors:')
  errors.forEach((e) => console.error(e))
  process.exit(1)
}

// Write the output file
fs.writeFileSync(outputFile, lines.join('\n') + '\n')
console.log(`Generated ${outputFile} with ${seen.size} wrapped exports`)
